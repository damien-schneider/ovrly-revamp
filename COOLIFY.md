# Coolify Deployment Guide for Ovrly

Deploy Ovrly on [Coolify](https://coolify.io/) with **fully self-hosted Convex**.

## Prerequisites

1. A Coolify instance with wildcard domain configured
2. A Twitch Developer application at [dev.twitch.tv](https://dev.twitch.tv/console/apps)

## Quick Start

### 1. Create Twitch Application

1. Go to [dev.twitch.tv/console/apps](https://dev.twitch.tv/console/apps)
2. Create a new application
3. Set OAuth Redirect URL to: `https://YOUR-CONVEX-SITE-DOMAIN/api/auth/callback/twitch`
   (Update after deployment with actual URL)
4. Copy **Client ID** and generate **Client Secret**

### 2. Deploy to Coolify

1. Create a new **Docker Compose** resource in Coolify
2. Connect your GitHub repository
3. Set docker-compose file path: `docker-compose.coolify.yml`
4. Add only **2 environment variables**:

```env
TWITCH_CLIENT_ID=your_twitch_client_id
TWITCH_CLIENT_SECRET=your_twitch_client_secret
```

5. Configure domains for services in Coolify UI
6. Deploy!

**That's it!** All secrets (`INSTANCE_SECRET`, `BOT_API_SECRET`) are auto-generated by Coolify via `$SERVICE_PASSWORD_*` magic variables.

### 3. Generate Admin Key

After deployment, SSH into your server:

```bash
docker ps | grep convex-backend
docker exec <container_id> ./generate_admin_key.sh
```

Save this key for deploying Convex functions.

### 4. Deploy Convex Functions

```bash
cd packages/backend

export CONVEX_SELF_HOSTED_URL=https://your-convex-api-url
export CONVEX_SELF_HOSTED_ADMIN_KEY=your_admin_key

mv .env.local .env.local.backup 2>/dev/null || true
bunx convex deploy --cmd 'echo "skip"'
mv .env.local.backup .env.local 2>/dev/null || true
```

### 5. Set Convex Environment Variables

```bash
export CONVEX_SELF_HOSTED_URL=https://your-convex-api-url
export CONVEX_SELF_HOSTED_ADMIN_KEY=your_admin_key

bunx convex env set SITE_URL "https://your-convex-site-url"
bunx convex env set WEB_APP_ORIGIN "https://your-web-app-url"
bunx convex env set TWITCH_CLIENT_ID "your_twitch_client_id"
bunx convex env set TWITCH_CLIENT_SECRET "your_twitch_client_secret"
bunx convex env set BETTER_AUTH_SECRET "$(openssl rand -base64 32)"
```

### 6. Update Twitch OAuth URL

Update your Twitch app's redirect URL to match your actual Convex site URL:
`https://your-convex-site-url/api/auth/callback/twitch`

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        Coolify Server                            │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐ │
│  │   Web App   │    │  Bot Server │    │   Convex Backend    │ │
│  │   :3001     │    │   :3002     │───▶│  :3210 / :3211      │ │
│  └─────────────┘    └─────────────┘    └─────────────────────┘ │
│                                                                 │
│         ┌─────────────────────────────────┐                     │
│         │      Convex Dashboard :6791     │                     │
│         └─────────────────────────────────┘                     │
└─────────────────────────────────────────────────────────────────┘
```

## Environment Variables

### Coolify (only 2 required!)

| Variable               | Required | Description              |
| ---------------------- | -------- | ------------------------ |
| `TWITCH_CLIENT_ID`     | ✅       | Twitch app client ID     |
| `TWITCH_CLIENT_SECRET` | ✅       | Twitch app client secret |

### Auto-Generated by Coolify

| Variable                   | Used By        |
| -------------------------- | -------------- |
| `$SERVICE_PASSWORD_CONVEX` | INSTANCE_SECRET |
| `$SERVICE_PASSWORD_BOT`    | BOT_API_SECRET  |
| `$SERVICE_URL_*`           | All service URLs |

### Convex (via `bunx convex env set`)

| Variable              | Description                        |
| --------------------- | ---------------------------------- |
| `SITE_URL`            | Convex HTTP URL (:3211)            |
| `WEB_APP_ORIGIN`      | Web app URL for CORS               |
| `TWITCH_CLIENT_ID`    | Same as Coolify                    |
| `TWITCH_CLIENT_SECRET`| Same as Coolify                    |
| `BETTER_AUTH_SECRET`  | Session encryption (generate once) |

## Troubleshooting

### Auth not working
- Check Twitch redirect URL matches exactly
- Verify Convex env vars: `bunx convex env list`
- WEB_APP_ORIGIN must match web app URL

### "state_mismatch" error
- SITE_URL must match Convex HTTP URL (port 3211)
- Check cookies aren't blocked

### Can't deploy functions
- Verify `CONVEX_SELF_HOSTED_URL` and admin key
- Move `.env.local` if it has `CONVEX_DEPLOYMENT`

## Database Options

**SQLite (Default)**: Stored in `convex-data` volume

**PostgreSQL**: Add to Coolify env:
```env
POSTGRES_URL=postgresql://user:password@host:5432/ovrly
```

## Backup & Restore

```bash
# Export
bunx convex export --path backup.zip

# Import
bunx convex import --replace-all backup.zip
```

# Docker Compose for Ovrly - Fully Self-Hosted
# Self-hosted deployment with Coolify or any Docker environment
#
# Services:
# - convex-backend: Self-hosted Convex backend (port 3210 API, 3211 HTTP actions)
# - convex-dashboard: Convex dashboard UI (port 6791)
# - web: Vite SPA frontend served by nginx (port 3001)
# - bot: Twitch bot server (port 3002)
#
# Quick Start:
# 1. Copy .env.example to .env and fill in your values
# 2. Run: docker compose up -d
# 3. Generate admin key: docker compose exec convex-backend ./generate_admin_key.sh
# 4. Visit dashboard at http://localhost:6791
# 5. Push Convex functions: CONVEX_SELF_HOSTED_URL=http://localhost:3210 CONVEX_SELF_HOSTED_ADMIN_KEY=<key> npx convex deploy

services:
  # ===========================================
  # Convex Backend (Self-Hosted)
  # ===========================================
  convex-backend:
    image: ghcr.io/get-convex/convex-backend:latest
    stop_grace_period: 10s
    stop_signal: SIGINT
    ports:
      - "${CONVEX_PORT:-3210}:3210"
      - "${CONVEX_SITE_PORT:-3211}:3211"
    volumes:
      - convex-data:/convex/data
    environment:
      # URLs for client/frontend access
      - CONVEX_CLOUD_ORIGIN=${CONVEX_CLOUD_ORIGIN:-http://127.0.0.1:3210}
      - CONVEX_SITE_ORIGIN=${CONVEX_SITE_ORIGIN:-http://127.0.0.1:3211}
      # Instance configuration
      - INSTANCE_NAME=${INSTANCE_NAME:-ovrly}
      - INSTANCE_SECRET=${INSTANCE_SECRET:-}
      # Database configuration (SQLite by default, or use Postgres/MySQL)
      - POSTGRES_URL=${POSTGRES_URL:-}
      - MYSQL_URL=${MYSQL_URL:-}
      - DO_NOT_REQUIRE_SSL=${DO_NOT_REQUIRE_SSL:-}
      # S3 storage (optional)
      - AWS_REGION=${AWS_REGION:-}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - S3_STORAGE_EXPORTS_BUCKET=${S3_STORAGE_EXPORTS_BUCKET:-}
      - S3_STORAGE_SNAPSHOT_IMPORTS_BUCKET=${S3_STORAGE_SNAPSHOT_IMPORTS_BUCKET:-}
      - S3_STORAGE_MODULES_BUCKET=${S3_STORAGE_MODULES_BUCKET:-}
      - S3_STORAGE_FILES_BUCKET=${S3_STORAGE_FILES_BUCKET:-}
      - S3_STORAGE_SEARCH_BUCKET=${S3_STORAGE_SEARCH_BUCKET:-}
      # Logging
      - RUST_LOG=${RUST_LOG:-info}
      - REDACT_LOGS_TO_CLIENT=${REDACT_LOGS_TO_CLIENT:-false}
      # Retention (2 days default)
      - DOCUMENT_RETENTION_DELAY=${DOCUMENT_RETENTION_DELAY:-172800}
    healthcheck:
      test: curl -f http://localhost:3210/version
      interval: 5s
      start_period: 10s
    restart: unless-stopped
    networks:
      - ovrly-network
    labels:
      - "coolify.managed=true"
      - "coolify.applicationId=${COOLIFY_APP_ID:-ovrly-convex}"

  # ===========================================
  # Convex Dashboard
  # ===========================================
  convex-dashboard:
    image: ghcr.io/get-convex/convex-dashboard:latest
    stop_grace_period: 10s
    stop_signal: SIGINT
    ports:
      - "${DASHBOARD_PORT:-6791}:6791"
    environment:
      - NEXT_PUBLIC_DEPLOYMENT_URL=${NEXT_PUBLIC_DEPLOYMENT_URL:-http://127.0.0.1:3210}
    depends_on:
      convex-backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - ovrly-network
    labels:
      - "coolify.managed=true"
      - "coolify.applicationId=${COOLIFY_APP_ID:-ovrly-dashboard}"

  # ===========================================
  # Web App (Vite SPA with nginx)
  # ===========================================
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      args:
        # Point to internal convex-backend service
        - VITE_CONVEX_URL=${VITE_CONVEX_URL:-http://convex-backend:3210}
        - VITE_CONVEX_SITE_URL=${VITE_CONVEX_SITE_URL:-http://convex-backend:3211}
        - VITE_TWITCH_CLIENT_ID=${VITE_TWITCH_CLIENT_ID}
        - VITE_BOT_SERVER_URL=${VITE_BOT_SERVER_URL:-http://bot:3002}
        - VITE_BOT_API_SECRET=${BOT_API_SECRET}
    ports:
      - "${WEB_PORT:-3001}:3001"
    depends_on:
      convex-backend:
        condition: service_healthy
      bot:
        condition: service_started
    restart: unless-stopped
    networks:
      - ovrly-network
    labels:
      - "coolify.managed=true"
      - "coolify.applicationId=${COOLIFY_APP_ID:-ovrly-web}"

  # ===========================================
  # Twitch Bot Server
  # ===========================================
  bot:
    build:
      context: .
      dockerfile: packages/twitch-bot/Dockerfile
    ports:
      - "${BOT_PORT:-3002}:3002"
    environment:
      - NODE_ENV=production
      - CONVEX_URL=${CONVEX_URL:-http://convex-backend:3210}
      - BOT_API_SECRET=${BOT_API_SECRET}
      - TWITCH_CLIENT_ID=${TWITCH_CLIENT_ID}
      - TWITCH_CLIENT_SECRET=${TWITCH_CLIENT_SECRET}
      - PORT=3002
    depends_on:
      convex-backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - ovrly-network
    labels:
      - "coolify.managed=true"
      - "coolify.applicationId=${COOLIFY_APP_ID:-ovrly-bot}"

volumes:
  convex-data:

networks:
  ovrly-network:
    driver: bridge
